import re


class Parser:
    @staticmethod
    def keys_parse(input_list):
        """ fill the key_list with parameters for rsync. """
        SINGLE_PARAM = tuple('PavSzqi')
        key_set = set()

        for item in Parser.gen(input_list):
            if (item.startswith('-')):
                if (all(ch in SINGLE_PARAM for ch in Parser.gen(item[1:]))):
                    key_set.update([('-' + char) for char in item[1:]])

        return (list(key_set))

    @staticmethod
    def hostrequest_parse(hostname_l):
        """ username:port@ip_address:/dir parsing """
        hostname = Parser.find_hostrequest(hostname_l)
        delim_ind = re.search("[.,:@]", hostname)
        username = hostname[:delim_ind.start()]
        port = ''
        if (hostname[delim_ind.start()] is not '@'):
            hostname = hostname[delim_ind.end():]
            delim_ind = re.search("[.,:@]", hostname)
            port = hostname[: delim_ind.start()]
        if ('/' in hostname):
            id_end = hostname.rfind(':')
            remote_dir = hostname[id_end + 1:]
        else:
            id_end = len(hostname)
            remote_dir = '/' + username
        host_id = hostname[delim_ind.end():id_end]

        data_dict_host = {'remote_dir': remote_dir,
                          'username': username, 'ip': host_id,
                          'port': port}

        return data_dict_host

    @staticmethod
    def port_to_keys(date_dict_port):
        """ Add '-p port' to a -e params, if port exist """
        port = date_dict_port['port']
        if (port):
            ind = 0
            keys_list = date_dict_port['keys']
            key_str = '-e \'ssh -p {}\''.format(port)

            if (any(item.startswith('-e') for item in Parser.gen(keys_list))):
                for item in keys_list:
                    if (item.startswith('-e')):
                        ind = keys_list.index(item)
                keys_list[ind] = key_str
            else:
                keys_list.append(key_str)
            date_dict_port['keys'] = keys_list

        return date_dict_port

    @staticmethod
    def find_hostrequest(some_lis):
        """ Looks for last non key item in list (without '-')
            saves it as class variable """
        for item in (Parser.gen(reversed(some_lis))):
            if (not item.startswith('-')):
                hostrequest = item
                return str(hostrequest)

    @staticmethod
    def gen(some_list):
        for item in some_list:
            yield item

    @staticmethod
    def main(data_dict, unknown_list):
        data_dict['keys'] += Parser.keys_parse(unknown_list)
        data_dict.update(Parser.hostrequest_parse(unknown_list))
        data_dict.update(Parser.port_to_keys(data_dict))
        # print data_dict
